#!/usr/bin/env ruby

require "optparse"
require "netrc"
require "octokit"
require "yaml"
require "pp"

def github
  @github ||= Octokit::Client.new(netrc: true)
end

Octokit.auto_paginate = true

repository = ARGV[0]
target = ARGV[1]

labels = github.labels(repository).map { |label|
  {
    "name"  => label[:name],
    "color" => label[:color],
  }
}

milestones = github.list_milestones(repository).map { |ms|
  {
    "name"        => ms[:title],
    "description" => ms[:description],
    "due_on"      => ms[:due_on],
    "state"       => ms[:state],
  }
}

config = {
  "repositories" => [ repository ],
  "label"        => labels,
}

config["milestones"] = milestones unless milestones.empty?

out = YAML.dump config
if target
  File.write(target, out)
else
  puts out
end
